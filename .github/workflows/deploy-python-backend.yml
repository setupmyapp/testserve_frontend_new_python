name: Deploy Python Backend to VPS

on:
  push:
    branches: [main]
    paths: ['**/*.py', 'requirements.txt', 'Dockerfile', 'docker-compose.yml']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ vars.VPS_HOST || '72.61.240.130' }} >> ~/.ssh/known_hosts

      - name: Rsync Python backend to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            --exclude __pycache__ --exclude .env --exclude .env.vps --exclude .git --exclude "Testserv extension" --exclude "*.zip" --exclude venv --exclude env \
            . ${{ vars.VPS_USER || 'root' }}@${{ vars.VPS_HOST || '72.61.240.130' }}:/opt/testserve-python-backend/

      - name: Build and run on VPS
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key \
            ${{ vars.VPS_USER || 'root' }}@${{ vars.VPS_HOST || '72.61.240.130' }} \
            'cd /opt/testserve-python-backend && (test -f .env.vps && cp .env.vps .env) || (test -f demo.txt && cp demo.txt .env) || true; docker compose build --no-cache && docker compose up -d'
